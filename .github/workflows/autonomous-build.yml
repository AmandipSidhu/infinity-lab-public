name: Autonomous Strategy Builder

on:
  issues:
    types: [opened, labeled]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  autonomous-build:
    if: contains(github.event.issue.labels.*.name, 'vm-command')
    runs-on: ubuntu-latest

    env:
      ISSUE_NUMBER: ${{ github.event.issue.number }}
      ISSUE_TITLE: ${{ github.event.issue.title }}
      ISSUE_URL: ${{ github.event.issue.html_url }}
      SPEC_PATH: /tmp/strategy_spec.yaml
      MCP_URL: http://localhost:8000/mcp
      ARTIFACT_REPO_PATH: infinity-lab-private

    steps:
      - name: 1Ô∏è‚É£ Checkout Private Repo (Artifacts/Scripts)
        uses: actions/checkout@v4
        with:
          repository: AmandipSidhu/infinity-lab-private
          token: ${{ secrets.INFINITY_PUBLIC_TO_PRIVATE_ACCESS }}
          path: infinity-lab-private

      - name: 2Ô∏è‚É£ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 3Ô∏è‚É£ Install Dependencies
        working-directory: ${{ env.ARTIFACT_REPO_PATH }}
        run: |
          set -e
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # ARCHITECTURE.md specifies quantconnect-mcp for HTTP transport server
          pip install quantconnect-mcp

      - name: 4Ô∏è‚É£ Slack: Build started
        if: always()
        working-directory: ${{ env.ARTIFACT_REPO_PATH }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          python scripts/notify_slack.py \
            --status "STARTED" \
            --issue "${ISSUE_NUMBER}" \
            --message "Build started: ${ISSUE_TITLE} (${ISSUE_URL})"

      - name: 5Ô∏è‚É£ Parse Issue Spec (extract YAML)
        id: parse
        working-directory: ${{ env.ARTIFACT_REPO_PATH }}
        run: |
          set -e
          python scripts/parse_issue.py \
            --issue-body '${{ github.event.issue.body }}' \
            --out "${SPEC_PATH}"
          echo "Parsed spec:" 
          cat "${SPEC_PATH}"

      - name: 6Ô∏è‚É£ Slack: Spec parsed
        if: always()
        working-directory: ${{ env.ARTIFACT_REPO_PATH }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          python scripts/notify_slack.py \
            --status "SPEC_PARSED" \
            --issue "${ISSUE_NUMBER}" \
            --message "Spec parsed and saved to ${SPEC_PATH}"

      - name: 7Ô∏è‚É£ Start QC MCP Server (HTTP)
        id: mcp
        working-directory: ${{ env.ARTIFACT_REPO_PATH }}
        env:
          QUANTCONNECT_USER_ID: ${{ secrets.QC_USER_ID }}
          QUANTCONNECT_API_TOKEN: ${{ secrets.QC_API_TOKEN }}
        run: |
          set -e
          echo "Starting QC MCP server on :8000 (streamable-http)"
          nohup python -m quantconnect_mcp.main \
            --transport streamable-http \
            --port 8000 \
            --host 0.0.0.0 \
            > /tmp/mcp-server.log 2>&1 &
          echo "MCP_PID=$!" >> $GITHUB_ENV

          sleep 10
          echo "MCP server log (head):"
          head -50 /tmp/mcp-server.log || true

          echo "Checking MCP endpoint: ${MCP_URL}"
          curl -sS --fail "${MCP_URL}" >/dev/null

      - name: 8Ô∏è‚É£ Slack: MCP server running
        if: always()
        working-directory: ${{ env.ARTIFACT_REPO_PATH }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          python scripts/notify_slack.py \
            --status "MCP_RUNNING" \
            --issue "${ISSUE_NUMBER}" \
            --message "QC MCP server running (HTTP): ${MCP_URL}"

      - name: 9Ô∏è‚É£ Discover QC MCP Tools
        working-directory: ${{ env.ARTIFACT_REPO_PATH }}
        env:
          MCP_SERVER_URL: ${{ env.MCP_URL }}
        run: |
          set -e
          python scripts/mcp_tool_discovery.py

      - name: üîü Slack: Tools discovered
        if: always()
        working-directory: ${{ env.ARTIFACT_REPO_PATH }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          python scripts/notify_slack.py \
            --status "TOOLS_READY" \
            --issue "${ISSUE_NUMBER}" \
            --message "QC MCP tools discovered; manifest updated."

      - name: 1Ô∏è‚É£1Ô∏è‚É£ Autonomous Build with Aider (Claude)
        id: build
        working-directory: ${{ env.ARTIFACT_REPO_PATH }}
        env:
          ANTHROPIC_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
          MCP_SERVER_URL: ${{ env.MCP_URL }}
          QC_USER_ID: ${{ secrets.QC_USER_ID }}
          QC_API_TOKEN: ${{ secrets.QC_API_TOKEN }}
        run: |
          set -e
          python scripts/aider_build_production.py \
            --spec "${SPEC_PATH}" \
            --output /tmp/strategy_output \
            --mcp-url "${MCP_URL}"

      - name: 1Ô∏è‚É£2Ô∏è‚É£ Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.INFINITY_PUBLIC_TO_PRIVATE_ACCESS }}
          commit-message: "feat: Strategy from issue #${{ github.event.issue.number }}"
          branch: "strategy/${{ github.event.issue.number }}"
          title: "Strategy: ${{ github.event.issue.title }}"
          body: |
            ## Autonomous Build Result

            **Issue:** #${{ github.event.issue.number }}
            **Strategy:** ${{ github.event.issue.title }}

            Auto-generated by Infinity Lab builder.
          labels: auto-generated,needs-review

      - name: 1Ô∏è‚É£3Ô∏è‚É£ Slack: PR created
        if: always()
        working-directory: ${{ env.ARTIFACT_REPO_PATH }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          PR_URL="${{ steps.cpr.outputs.pull-request-url }}"
          PR_NUM="${{ steps.cpr.outputs.pull-request-number }}"
          python scripts/notify_slack.py \
            --status "PR_CREATED" \
            --issue "${ISSUE_NUMBER}" \
            --pr "${PR_NUM}" \
            --message "PR created: ${PR_URL}"

      - name: 1Ô∏è‚É£4Ô∏è‚É£ Final Slack Notification
        if: always()
        working-directory: ${{ env.ARTIFACT_REPO_PATH }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          python scripts/notify_slack.py \
            --status "${{ job.status }}" \
            --issue "${ISSUE_NUMBER}" \
            --pr "${{ steps.cpr.outputs.pull-request-number }}"

      - name: üßπ Cleanup
        if: always()
        run: |
          if [ -n "${MCP_PID:-}" ]; then
            kill "$MCP_PID" || true
          fi
          echo "Final MCP logs (tail):"
          tail -100 /tmp/mcp-server.log || true
