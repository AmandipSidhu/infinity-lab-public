name: Autonomous Strategy Builder

on:
  repository_dispatch:
    types: [build-strategy]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  autonomous-build:
    runs-on: ubuntu-latest
    
    steps:
      - name: 1Ô∏è‚É£ Checkout Private Repo (Scripts)
        uses: actions/checkout@v4
        with:
          repository: AmandipSidhu/infinity-lab-library
          token: ${{ secrets.INFINITY_PUBLIC_TO_PRIVATE_ACCESS }}
          path: infinity-lab-library
      
      - name: 2Ô∏è‚É£ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: 3Ô∏è‚É£ Install Dependencies
        working-directory: infinity-lab-library
        run: |
          pip install -r requirements.txt
      
      - name: 4Ô∏è‚É£ Parse Issue Spec
        id: parse
        working-directory: infinity-lab-library
        run: |
          echo '${{ github.event.client_payload.issue_body }}' > /tmp/issue_body.txt
          python scripts/parse_issue.py "$(cat /tmp/issue_body.txt)"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: 5Ô∏è‚É£ Start QC MCP Server (Docker)
        run: |
          echo "üöÄ Starting official QuantConnect MCP server via Docker..."
          
          docker run -d \
            --name quantconnect-mcp-server \
            --platform linux/amd64 \
            -e QUANTCONNECT_USER_ID=${{ secrets.QC_USER_ID }} \
            -e QUANTCONNECT_API_TOKEN=${{ secrets.QC_API_TOKEN }} \
            -e AGENT_NAME="GitHub Actions" \
            -p 8000:8000 \
            quantconnect/mcp-server
          
          echo "‚è≥ Waiting for MCP server to start..."
          sleep 10
          
          if docker ps | grep quantconnect-mcp-server; then
            echo "‚úÖ QC MCP server running"
            docker logs quantconnect-mcp-server
          else
            echo "‚ùå MCP server failed to start"
            docker logs quantconnect-mcp-server
            exit 1
          fi
      
      - name: 6Ô∏è‚É£ Discover QC MCP Tools
        working-directory: infinity-lab-library
        run: python scripts/mcp_tool_discovery.py
        env:
          MCP_SERVER_URL: "http://localhost:8000"
          QC_USER_ID: ${{ secrets.QC_USER_ID }}
          QC_API_TOKEN: ${{ secrets.QC_API_TOKEN }}
      
      - name: 7Ô∏è‚É£ Autonomous Build with Aider
        working-directory: infinity-lab-library
        run: |
          aider \
            --model claude-sonnet-4.5 \
            --yes-always \
            --no-auto-commits \
            --message "Build QuantConnect strategy from issue #${{ github.event.client_payload.issue_number }}" \
            --message "Spec: $(cat /tmp/strategy_spec.yaml)" \
            --message "Use QC MCP tools at http://localhost:8000" \
            --system-prompt "$(cat config/aider_system_prompt_with_tools.txt)" \
            --output /tmp/strategy_output/
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          MCP_SERVER_URL: "http://localhost:8000"
      
      - name: 8Ô∏è‚É£ Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.INFINITY_PUBLIC_TO_PRIVATE_ACCESS }}
          commit-message: "feat: Add strategy from issue #${{ github.event.client_payload.issue_number }}"
          branch: strategy/${{ github.event.client_payload.issue_number }}
          title: "Strategy: ${{ github.event.client_payload.issue_title }}"
          body: |
            ## Autonomous Build Result
            
            **Issue:** ${{ github.event.client_payload.issue_url }}
            **Strategy:** ${{ github.event.client_payload.issue_title }}
            
            This PR was automatically generated by the Infinity Lab autonomous builder.
            
            ### Next Steps
            - Review the generated code
            - Check backtest results
            - Approve or request changes
          labels: auto-generated,needs-review
      
      - name: 9Ô∏è‚É£ Notify Slack
        if: always()
        working-directory: infinity-lab-library
        run: |
          python scripts/notify_slack.py \
            --status "${{ job.status }}" \
            --issue "${{ github.event.client_payload.issue_number }}" \
            --pr "${{ steps.cpr.outputs.pull-request-number }}"
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      
      - name: üßπ Cleanup
        if: always()
        run: |
          echo "üßπ Cleaning up MCP server..."
          docker stop quantconnect-mcp-server || true
          docker rm quantconnect-mcp-server || true
          echo "‚úÖ Cleanup complete"