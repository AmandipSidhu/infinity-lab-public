name: Autonomous Strategy Builder

on:
  issues:
    types: [opened, labeled]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  autonomous-build:
    if: contains(github.event.issue.labels.*.name, 'vm-command')
    runs-on: ubuntu-latest
    
    steps:
      - name: 1Ô∏è‚É£ Checkout Private Repo (Scripts)
        uses: actions/checkout@v4
        with:
          repository: AmandipSidhu/infinity-lab-library
          token: ${{ secrets.INFINITY_PUBLIC_TO_PRIVATE_ACCESS }}
          path: infinity-lab-library
      
      - name: 2Ô∏è‚É£ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: 3Ô∏è‚É£ Install Dependencies
        working-directory: infinity-lab-library
        run: pip install -r requirements.txt
      
      - name: 4Ô∏è‚É£ Parse Issue Spec
        id: parse
        working-directory: infinity-lab-library
        run: |
          python scripts/parse_spec_yaml.py '${{ github.event.issue.body }}' > /tmp/strategy_spec.yaml
          cat /tmp/strategy_spec.yaml
      
      - name: 5Ô∏è‚É£ Start QC MCP Server (Docker)
        run: |
          docker run -d \
            --name qc-mcp \
            --platform linux/amd64 \
            -e QUANTCONNECT_USER_ID=${{ secrets.QC_USER_ID }} \
            -e QUANTCONNECT_API_TOKEN=${{ secrets.QC_API_TOKEN }} \
            -p 8000:8000 \
            quantconnect/mcp-server
          
          sleep 15
          docker logs qc-mcp
      
      - name: 6Ô∏è‚É£ Discover QC MCP Tools
        working-directory: infinity-lab-library
        run: python scripts/mcp_tool_discovery.py
        env:
          MCP_SERVER_URL: http://localhost:8000
      
      - name: 7Ô∏è‚É£ Autonomous Build with Aider
        working-directory: infinity-lab-library
        run: |
          python scripts/aider_build_production.py \
            --spec /tmp/strategy_spec.yaml \
            --output /tmp/strategy_output \
            --mcp-url http://localhost:8000
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          QC_USER_ID: ${{ secrets.QC_USER_ID }}
          QC_API_TOKEN: ${{ secrets.QC_API_TOKEN }}
      
      - name: 8Ô∏è‚É£ Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.INFINITY_PUBLIC_TO_PRIVATE_ACCESS }}
          commit-message: 'feat: Strategy from issue #${{ github.event.issue.number }}'
          branch: strategy/${{ github.event.issue.number }}
          title: 'Strategy: ${{ github.event.issue.title }}'
          body: |
            ## Autonomous Build Result
            
            **Issue:** #${{ github.event.issue.number }}
            **Strategy:** ${{ github.event.issue.title }}
            
            Auto-generated by Infinity Lab builder.
          labels: auto-generated,needs-review
      
      - name: 9Ô∏è‚É£ Notify Slack
        if: always()
        working-directory: infinity-lab-library
        run: |
          python scripts/notify_slack.py \
            --status "${{ job.status }}" \
            --issue "${{ github.event.issue.number }}" \
            --pr "${{ steps.cpr.outputs.pull-request-number }}"
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      
      - name: üßπ Cleanup
        if: always()
        run: |
          docker stop qc-mcp || true
          docker rm qc-mcp || true