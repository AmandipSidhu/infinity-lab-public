# Autonomous Strategy Build Workflow
#
# HOW TO TRIGGER (for AI assistants):
# 1. Create a GitHub issue in this repo (infinity-lab-public)
# 2. Add label: "autonomous-build"
# 3. Issue body = strategy request (e.g., "Create RSI strategy for SPY")
# 4. Workflow automatically starts Aider with full MCP stack
#
# Example:
#   Title: "Build momentum strategy"
#   Body: "Create a 20-day SMA crossover strategy for QQQ"
#   Labels: ["autonomous-build"]
#
# Aider will have access to:
# - QuantConnect MCP (60+ trading tools)
# - Linear MCP (task tracking)
# - Memory MCP (knowledge graph)
# - Sequential Thinking MCP (reasoning)

name: Autonomous Strategy Build

on:
  issues:
    types: [opened, labeled]
  workflow_dispatch:
    inputs:
      strategy_request:
        description: 'Strategy build request'
        required: true
        type: string
      issue_number:
        description: 'GitHub issue number (optional)'
        required: false
        type: string

permissions:
  contents: write
  issues: write

jobs:
  build-strategy:
    # Only run if issue has 'autonomous-build' label OR manually triggered
    if: |
      (github.event_name == 'issues' && contains(github.event.issue.labels.*.name, 'autonomous-build')) ||
      github.event_name == 'workflow_dispatch'
    
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Add starting comment to issue
        if: github.event_name == 'issues'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸš€ **Autonomous build started**\n\nAider is now building your strategy with full MCP stack access.\n\nRun: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}'
            })
      
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Setup Docker
        uses: docker/setup-buildx-action@v3
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Make scripts executable
        run: |
          chmod +x scripts/*.sh
      
      - name: Configure MCP environment
        run: |
          mkdir -p ~/.config
          cat > ~/.env.mcp << EOF
          LINEAR_API_KEY=${{ secrets.LINEAR_API_KEY }}
          QUANTCONNECT_USER_ID=${{ secrets.QC_USER_ID }}
          QUANTCONNECT_API_TOKEN=${{ secrets.QC_API_TOKEN }}
          GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}
          MEMORY_FILE_PATH=$HOME/mcp-data/memory.json
          EOF
      
      - name: Install MCP dependencies
        run: |
          bash scripts/install_mcp_deps.sh
      
      - name: Start MCP servers
        run: |
          bash scripts/start_all_mcps.sh
          echo "âœ… MCP servers started"
      
      - name: Install Aider
        run: |
          pip install aider-chat
      
      - name: Set strategy request
        id: strategy
        run: |
          if [ "${{ github.event_name }}" = "issues" ]; then
            # Extract strategy request from issue body (heredoc for multi-line)
            echo 'request<<EOF' >> $GITHUB_OUTPUT
            echo "${{ github.event.issue.body }}" >> $GITHUB_OUTPUT
            echo 'EOF' >> $GITHUB_OUTPUT
            echo "issue_num=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          else
            # Use manual input (heredoc for multi-line)
            echo 'request<<EOF' >> $GITHUB_OUTPUT
            echo "${{ github.event.inputs.strategy_request }}" >> $GITHUB_OUTPUT
            echo 'EOF' >> $GITHUB_OUTPUT
            echo "issue_num=${{ github.event.inputs.issue_number }}" >> $GITHUB_OUTPUT
          fi
      
      - name: Run Aider autonomous build
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          # Configure Aider with MCP endpoints
          cat > aider_mcp_config.json << EOF
          {
            "mcp_servers": {
              "quantconnect": "http://localhost:8000/mcp",
              "linear": "http://localhost:8001/mcp",
              "memory": "http://localhost:8002/mcp",
              "thinking": "http://localhost:8003/mcp"
            }
          }
          EOF
          
          # Run Aider with strategy request
          aider \
            --message "${{ steps.strategy.outputs.request }}" \
            --yes \
            --auto-commits \
            --model claude-3-5-sonnet-20241022 \
            --config aider_mcp_config.json
      
      - name: Comment success on issue
        if: success() && github.event_name == 'issues'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… **Build completed successfully**\n\nStrategy has been built and committed. Check the [workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.'
            })
      
      - name: Comment failure on issue
        if: failure() && github.event_name == 'issues'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âŒ **Build failed**\n\nSee [workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for error details.'
            })
      
      - name: Show MCP logs on failure
        if: failure()
        run: |
          echo "=== QuantConnect MCP logs ==="
          docker logs quantconnect-mcp --tail 50 || echo "No Docker logs"
          
          echo "=== Linear MCP logs ==="
          tail -50 ~/mcp-logs/linear-mcp.log || echo "No Linear logs"
          
          echo "=== Memory MCP logs ==="
          tail -50 ~/mcp-logs/memory-mcp.log || echo "No Memory logs"
          
          echo "=== Sequential Thinking logs ==="
          tail -50 ~/mcp-logs/thinking-mcp.log || echo "No Thinking logs"
      
      - name: Stop MCP servers
        if: always()
        run: |
          bash scripts/stop_all_mcps.sh
      
      - name: Upload strategy artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: strategy-build-${{ github.run_number }}
          path: |
            strategies/
            backtests/
            *.py
