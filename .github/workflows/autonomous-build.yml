name: Autonomous Strategy Builder

on:
  issues:
    types: [opened, labeled]

jobs:
  autonomous-build:
    if: contains(github.event.issue.labels.*.name, 'vm-command')
    runs-on: ubuntu-latest
    
    permissions:
      issues: write
      contents: write
      pull-requests: write
    
    steps:
      - name: 1ï¸âƒ£ Checkout Private Repo (Scripts)
        uses: actions/checkout@v4
        with:
          repository: AmandipSidhu/infinity-lab-library
          token: ${{ secrets.PAT_TOKEN }}
          path: infinity-lab-library
      
      - name: 2ï¸âƒ£ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: 3ï¸âƒ£ Install Dependencies
        working-directory: infinity-lab-library
        run: |
          pip install -r requirements.txt
          pip install quantconnect-mcp  # Third-party MCP with HTTP support
      
      - name: 4ï¸âƒ£ Parse Issue Spec
        id: parse
        working-directory: infinity-lab-library
        run: python scripts/parse_issue.py "${{ github.event.issue.body }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: 5ï¸âƒ£ Start QC MCP Server (HTTP Transport)
        run: |
          echo "ðŸš€ Starting QuantConnect MCP server with HTTP transport..."
          
          # Start MCP server with streamable-http transport
          nohup python -m quantconnect_mcp.main \
            --transport streamable-http \
            --port 8000 \
            --host 0.0.0.0 \
            > /tmp/mcp-server.log 2>&1 &
          
          MCP_PID=$!
          echo "MCP_PID=$MCP_PID" >> $GITHUB_ENV
          echo "ðŸ“ MCP server started with PID: $MCP_PID"
          
          # Wait for server to be ready
          echo "â³ Waiting for MCP server to start..."
          sleep 10
          
          # Health check
          if ps -p $MCP_PID > /dev/null; then
            echo "âœ… QC MCP server running (PID: $MCP_PID)"
            echo "ðŸ“Š Server logs:"
            tail -20 /tmp/mcp-server.log
          else
            echo "âŒ MCP server failed to start"
            echo "ðŸ“‹ Full logs:"
            cat /tmp/mcp-server.log
            exit 1
          fi
        env:
          QUANTCONNECT_USER_ID: ${{ secrets.QC_USER_ID }}
          QUANTCONNECT_API_TOKEN: ${{ secrets.QC_API_TOKEN }}
      
      - name: 6ï¸âƒ£ Discover QC MCP Tools
        working-directory: infinity-lab-library
        run: python scripts/mcp_tool_discovery.py
        env:
          MCP_SERVER_URL: "http://localhost:8000"
          QC_USER_ID: ${{ secrets.QC_USER_ID }}
          QC_API_TOKEN: ${{ secrets.QC_API_TOKEN }}
      
      - name: 7ï¸âƒ£ Autonomous Build with Aider
        working-directory: infinity-lab-library
        run: |
          # Run Aider with MCP tools
          aider \
            --model claude-sonnet-4.5 \
            --yes-always \
            --no-auto-commits \
            --message "Build QuantConnect strategy: ${{ steps.parse.outputs.strategy_name }}" \
            --message "Spec: $(cat /tmp/strategy_spec.yaml)" \
            --message "Use QC MCP tools at http://localhost:8000" \
            --system-prompt "$(cat config/aider_system_prompt_with_tools.txt)" \
            --output /tmp/strategy_output/
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          MCP_SERVER_URL: "http://localhost:8000"
      
      - name: 8ï¸âƒ£ Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.PAT_TOKEN }}
          commit-message: "feat: Add ${{ steps.parse.outputs.strategy_name }} strategy"
          branch: strategy/${{ github.event.issue.number }}
          title: "Strategy: ${{ steps.parse.outputs.strategy_name }}"
          body: |
            ## Autonomous Build Result
            
            **Issue:** #${{ github.event.issue.number }}
            **Strategy:** ${{ steps.parse.outputs.strategy_name }}
            
            This PR was automatically generated by the Infinity Lab autonomous builder.
            
            ### Next Steps
            - Review the generated code
            - Check backtest results
            - Approve or request changes
          labels: auto-generated,needs-review
      
      - name: 9ï¸âƒ£ Notify Slack
        if: always()
        working-directory: infinity-lab-library
        run: |
          python scripts/notify_slack.py \
            --status "${{ job.status }}" \
            --issue "${{ github.event.issue.number }}" \
            --pr "${{ steps.cpr.outputs.pull-request-number }}"
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      
      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up MCP server..."
          if [ ! -z "$MCP_PID" ]; then
            kill $MCP_PID 2>/dev/null || true
            echo "âœ… MCP server stopped (PID: $MCP_PID)"
          fi
          
          echo "ðŸ“‹ Final MCP server logs:"
          tail -50 /tmp/mcp-server.log || true