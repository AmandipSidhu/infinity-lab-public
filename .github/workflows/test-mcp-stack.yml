name: Test MCP Stack

on:
  workflow_dispatch:
  push:
    paths:
      - 'scripts/**'
      - '.github/workflows/test-mcp-stack.yml'
      - 'ARCHITECTURE_v2.9.md'

jobs:
  test-mcp-stack:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Docker
        uses: docker/setup-buildx-action@v3

      - name: Install jq (for JSON parsing in tests)
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Make scripts executable
        run: chmod +x scripts/*.sh

      - name: Create .env.mcp from GitHub Secrets
        run: |
          cat > ~/.env.mcp << EOF
          # Auto-generated from GitHub Secrets
          LINEAR_API_KEY=${{ secrets.LINEAR_API_KEY }}
          QUANTCONNECT_USER_ID=${{ secrets.QC_USER_ID }}
          QUANTCONNECT_API_TOKEN=${{ secrets.QC_API_TOKEN }}
          GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}
          MEMORY_FILE_PATH=$HOME/mcp-data/memory.json
          EOF
          echo "‚úÖ Created ~/.env.mcp from secrets"

      - name: Install MCP dependencies
        run: |
          bash scripts/install_mcp_deps.sh

      - name: Start all MCP servers
        run: |
          bash scripts/start_all_mcps.sh

      - name: Run MCP Integration Tests
        run: |
          echo "üß™ Running comprehensive MCP integration tests..."
          bash scripts/test_mcp_integration.sh 300

      - name: Check MCP logs
        if: always()
        run: |
          echo "üìã MCP Server Logs:"
          echo ""
          echo "=== QuantConnect MCP (Supergateway wrapper) ==="
          tail -50 ~/mcp-logs/quantconnect-mcp.log || echo "No QuantConnect logs"
          echo ""
          echo "=== Linear MCP (Supergateway wrapper) ==="
          tail -50 ~/mcp-logs/linear-mcp.log || echo "No Linear logs"
          echo ""
          echo "=== Memory MCP (Supergateway wrapper) ==="
          tail -50 ~/mcp-logs/memory-mcp.log || echo "No Memory logs"
          echo ""
          echo "=== Sequential Thinking MCP ==="
          tail -50 ~/mcp-logs/thinking-mcp.log || echo "No Thinking logs"
          echo ""
          echo "=== Docker Containers ==="
          docker ps -a | grep quantconnect || echo "No QuantConnect Docker containers"

      - name: Stop all MCP servers
        if: always()
        run: |
          bash scripts/stop_all_mcps.sh

      - name: Verify clean shutdown
        if: always()
        run: |
          echo "üîç Verifying all processes stopped..."
          
          # Check if any MCP processes still running
          if pgrep -f "supergateway" > /dev/null; then
            echo "‚ö†Ô∏è Supergateway processes still running"
            pgrep -af "supergateway"
            exit 1
          else
            echo "‚úÖ No Supergateway processes"
          fi
          
          if pgrep -f "sequential-thinking" > /dev/null; then
            echo "‚ö†Ô∏è Sequential Thinking still running"
            pgrep -af "sequential-thinking"
            exit 1
          else
            echo "‚úÖ No Sequential Thinking processes"
          fi
          
          # Check if ports are free
          for port in 8000 8001 8002 8003; do
            if lsof -ti :${port} > /dev/null 2>&1; then
              echo "‚ö†Ô∏è Port ${port} still in use"
              lsof -i :${port}
              exit 1
            fi
          done
          echo "‚úÖ All ports free"
          
          if docker ps -a | grep quantconnect > /dev/null; then
            echo "‚ö†Ô∏è QuantConnect Docker containers found"
            docker ps -a | grep quantconnect
            exit 1
          else
            echo "‚úÖ No QuantConnect Docker containers"
          fi
          
          echo "‚úÖ Clean shutdown verified"

      - name: Report results to Linear
        if: always()
        env:
          LINEAR_API_KEY: ${{ secrets.LINEAR_API_KEY }}
        run: |
          # TODO: Add Linear API call to update UNI-50 with test results
          echo "üìä Test Results:"
          echo "  Workflow: ${{ github.workflow }}"
          echo "  Run: ${{ github.run_number }}"
          echo "  Status: ${{ job.status }}"
